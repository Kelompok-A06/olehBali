{% extends 'base.html' %}

{% block content %}
  <h2>{{ post.title }}</h2>
  <p>{{ post.content }}</p>
  <p>By {{ post.author.username }} on {{ post.created_at }}</p>

  <h3>Comments</h3>
  <ul id="comment-list">
    {% for comment in comments %}
      <li>{{ comment.content }} - by {{ comment.author.username }}</li>
    {% endfor %}
  </ul>

  <h4>Add a Comment</h4>
  <form id="comment-form" method="post">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit">Submit</button>
  </form>

  <script>
    const form = document.getElementById('comment-form');
    form.onsubmit = async function(event) {
      event.preventDefault();
      const formData = new FormData(form);
      const response = await fetch("{% url 'post_detail' post.id %}", {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      if (result.success) {
        const commentList = document.getElementById('comment-list');
        const newComment = document.createElement('li');
        newComment.innerText = `${result.comment} - by ${result.author}`;
        commentList.appendChild(newComment);
        form.reset();
      } else {
        alert('Failed to add comment.');
      }
    };
  </script>
{% endblock %}
